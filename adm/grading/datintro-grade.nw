\section{Usage}

We need to set use the following setup for the Docker container to work.
We need the following environment variables:
\begin{itemize}
\item [[KRB_USER]] and [[KRB_PASS]] containing the Kerberos username (including 
@realm) and password for the user to access the SSH servers.
\item [[CANVAS_SERVER]] and [[CANVAS_TOKEN]] to authenticate the [[canvaslms]] 
command.
See [[canvaslms login -h]].
%\item [[LADOK_USER]] and [[LADOK_PASS]] containing the LADOK username and 
%password to use.
%See [[ladok login -h]].
\item [[REPOBEE_USER]], [[REPOBEE_URL]], [[REPOBEE_TOKEN]] as configuration for 
RepoBee.
See the RepoBee documentation for details:
\item [[COURSE_CODE]] containing a space-separated list of regular expressions 
for the course code, [[COURSE_CODE_ORG]] containing a space-separated list of 
  course code and GitHub organization name pairs.
\begin{center}
\texttt{https://docs.repobee.org/en/stable/getting\textunderscore{}started.html}
\end{center}
\end{itemize}
We also must mount the AFS root (/afs) in the container (to access 
/afs/kth.se).
So if we have set those environment variables and have AFS mounted in /afs, 
then we can run this image as follows:
\begin{verbatim}
docker run \
  -e KRB_USER -e KRB_PASS \
  -e CANVAS_SERVER -e CANVAS_TOKEN \
  -e REPBEE_USER -e REPOBEE_URL -e REPOBEE_TOKEN \
  -e COURSE_CODE -e COURSE_CODE_ORG \
  -v /afs:/afs \
    datintro22-grade:latest
\end{verbatim}


\section{Overview}

We want to build a Docker image to run all the necessary grading in the course.
We use RepoBee to work with the students' repos, so we can base our work on 
that image.
Then we install the grading scripts and run them all by default.
<<Dockerfile>>=
FROM ubuntu

USER root
WORKDIR grader

<<set up canvaslms in container>>
<<set up repobee in container>>
<<set up grading scripts in container>>
@

Next is building the Docker image.
We use the phony target [[${IMAGE_TARGET}]] for this.
This variable should be updated whenever we change the assignments, so that the 
grading procedure must change between courses.
<<datintro-grade.mk>>=
IMAGE_TARGET=   datintro22-grade

.PHONY: all
all: ${IMAGE_TARGET}

.PHONY: ${IMAGE_TARGET}
${IMAGE_TARGET}: Dockerfile
	docker build -t $@ .

Dockerfile: datintro-grade.nw
	${NOTANGLE}

.PHONY: clean clean-docker
clean: clean-docker
clean-docker:
	${RM} Dockerfile

.PHONY: distclean distclean-docker
distclean: distclean-docker
distclean-docker:
	-docker image rm -f ${IMAGE_TARGET}

<<build the grading scripts>>
<<clean targets>>
@


\section{Set up \texttt{canvaslms} and \texttt{ladok3}}

We need the [[canvaslms]] command inside the container since the scripts rely 
heavily on this.
So we install it using [[pip]].
Now, since it depends on the [[cryptography]] package, we need to install the 
dependencies\footnote{%
  See \texttt{https://stackoverflow.com/a/53562393/1305099}.
}.
We also want to install the [[ladok]] command to report whenever we have any 
passing results.
<<set up canvaslms in container>>=
RUN apt-get update && \
  apt-get install -y \
    build-essential \
    libffi-dev musl-dev \
    python3-pip && \
  python3 -m pip install --no-cache-dir canvaslms ladok3 && \
  apt-get purge -y build-essential \
    libffi-dev musl-dev && \
  apt-get autoremove -y
@


\section{Set up \texttt{repobee}}

We also want RepoBee in the container.
So we run their install script to install it rather than using their Docker 
image.
Their Docker image is based on Alpine, which doesn't have SSH that supports 
Kerberos.
<<set up repobee in container>>=
RUN apt-get update && apt-get install -y curl git python3-venv && \
  curl -s https://repobee.org/install.sh > repobee-install.sh && \
  bash repobee-install.sh
ENV PATH "$PATH:/root/.repobee/bin"
@


\section{All grading scripts}

We have a separate grading script for each assignment.
When we run the container we'd like all those scripts to run, so we create the 
[[grade-all.sh]] script that runs them all.

This script will also set up the prerequisites for the individual grading 
scripts.
For starters, all scripts requires SSH to be set up with an agent to 
authenticate using public keys.
<<grade-all.sh>>=
#!/bin/bash

<<initialize SSH authentication for run>>

./grade-ssh.sh
./grade-terminal.sh
./grade-git.sh
./grade-latex.sh
@

Now, we must copy all those scripts into the container and set the executable 
bit.
These scripts also need the standard commands, which are not included in alpine 
(the base Docker image for RepoBee).
Then we make sure to execute [[grade-all.sh]] by default when the container is 
run.
<<set up grading scripts in container>>=
<<set up SSH in container>>

COPY grade-all.sh common.sh \
  grade-ssh.sh grade-terminal.sh grade-git.sh grade-latex.sh ./
RUN chmod +x grade-all.sh common.sh \
  grade-ssh.sh grade-terminal.sh grade-git.sh grade-latex.sh

RUN apt-get update && apt-get install -y util-linux \
  coreutils findutils grep binutils acct

CMD ["/bin/bash", "grade-all.sh"]
@

To build the container we need [[make]] to first build local copies of all 
scripts.
<<build the grading scripts>>=
grade-all.sh: datintro-grade.nw
	${NOTANGLE.sh}

grade-ssh.sh: ../../modules/ssh/grading/grade.sh
grade-terminal.sh: ../../modules/terminal/grading/grade.sh
grade-git.sh: ../../modules/git/grading/grade.sh
grade-latex.sh: ../../modules/latex/grading/grade.sh

grade-ssh.sh grade-terminal.sh grade-git.sh grade-latex.sh:
	${CP} $^ $@

../%:
	${MAKE} -C $(dir $@) $(notdir $@)

${IMAGE_TARGET}: grade-all.sh common.sh
${IMAGE_TARGET}: grade-ssh.sh grade-terminal.sh grade-git.sh grade-latex.sh
@

Finally, we add some cleaning.
<<clean targets>>=
.PHONY: clean-scripts
clean: clean-scripts
clean-scripts:
	${RM} grade-all.sh common.sh
	${RM} grade-ssh.sh grade-terminal.sh grade-git.sh grade-latex.sh
	${MAKE} -C ../../modules/ssh/grading clean
	${MAKE} -C ../../modules/terminal/grading clean
	${MAKE} -C ../../modules/git/grading clean
	${MAKE} -C ../../modules/latex/grading clean

.PHONY: distclean-scripts
distclean: distclean-scripts
distclean-scripts:
	${MAKE} -C ../../modules/ssh/grading distclean
	${MAKE} -C ../../modules/terminal/grading distclean
	${MAKE} -C ../../modules/git/grading distclean
	${MAKE} -C ../../modules/latex/grading distclean
@


\section{Set up SSH}

We need to have SSH inside the container.
Since we want to interact with KTH systems, we also need Kerberos.
Then we want to have server specific configuration (the [[config]] file).
<<set up SSH in container>>=
RUN apt-get update && \
  DEBIAN_FRONTEND=noninteractive TZ=Europe/Stockholm apt-get install -y \
    openssh-client heimdal-clients
COPY config /root/.ssh/
RUN chmod -R 0600 /root/.ssh
@

To do this we need the [[Makefile]] to build the [[config]] file.
<<generate SSH keys>>=
config: ${HOME}/.ssh/config
	${CP} $^ $@

${IMAGE_TARGET}: config
@

To set up the Kerberos authentication, we simply take the credentials from the 
environment.
<<initialize SSH authentication for run>>=
krb_pass_file=$(mktemp)

echo $KRB_PASS > $krb_pass_file
kinit -f --password-file=$krb_pass_file $KRB_USER

rm $krb_pass_file
@


\section{Log the runs}

We want to log the runs so that the students can see when the script runs.
We will do this by writing to a text file that is publicly accessible.
<<write start time to log>>=
LOG_FILE="/afs/kth.se/home/d/b/dbosk/public_html/datintro/grader.txt"
mkdir -p $(dirname $LOG_FILE)

echo -n "Started grading $(date)" >> $LOG_FILE
@
<<write end time to log>>=
echo " -> Finished $(date)" >> $LOG_FILE
@

However, due to how the container is run by Docker, it doesn't get write access 
through the user's Kerberos credentials.
So this code must be run outside of the container.
